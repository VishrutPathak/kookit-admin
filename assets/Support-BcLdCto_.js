import{r as i,l as R,j as e,s as T,c as y}from"./index-DyF85uUZ.js";import{u as F}from"./users-DNrr3Qg9.js";const j=[{id:"t1",subject:"Device not connecting to Wi-Fi",userId:"u1001",status:"open",createdAt:"2025-09-22T10:15:00Z",messages:[{id:"m1",author:"Asha Rao",text:"My Kookit Pad A1 won't connect to home Wi-Fi.",createdAt:"2025-09-22T10:15:00Z"},{id:"m2",author:"Support",text:"Hi Asha — can you confirm signal strength near the device?",createdAt:"2025-09-22T11:05:00Z"}]},{id:"t2",subject:"How to reset recipe data",userId:null,status:"resolved",createdAt:"2025-09-20T08:30:00Z",messages:[{id:"m1",author:"Admin",text:"Guide: go to Recipes > Reset to restore defaults.",createdAt:"2025-09-20T08:30:00Z"}]}];function S(c){try{return new Date(c).toLocaleString()}catch{return c}}function $(){const[c,b]=i.useState([]),[f,D]=i.useState("open"),[g,C]=i.useState(""),[A,o]=i.useState(null),[h,d]=i.useState(""),[N,k]=i.useState(""),[p,w]=i.useState(""),v=i.useMemo(()=>R("kookit_users",null)?.users??F?.users??[],[]);i.useEffect(()=>{try{const t=R("kookit_tickets",null)?.tickets??j;b(Array.isArray(t)?t:j)}catch(s){console.error("Failed to load tickets:",s),b(j)}},[]);const x=s=>{b(s),T("kookit_tickets",{tickets:s})},I=c.filter(s=>{if(f!=="all"&&s.status!==f)return!1;if(!g)return!0;const t=g.toLowerCase();return!!((s.subject||"").toLowerCase().includes(t)||(s.messages||[]).some(a=>(a.text||"").toLowerCase().includes(t)||(a.author||"").toLowerCase().includes(t)))}),E=s=>o(s),L=s=>{if(s.preventDefault(),!N?.trim())return alert("Enter a subject");const t=y("t"),a=y("m"),m={id:t,subject:N.trim(),userId:p||null,status:"open",createdAt:new Date().toISOString(),messages:[{id:a,author:p?v.find(l=>l.id===p)?.name??"User":"Admin",text:h||"(no message)",createdAt:new Date().toISOString()}]};x([m,...c]),k(""),w(""),d(""),o(t)},M=s=>{if(!h?.trim())return;const t=c.map(a=>{if(a.id!==s)return a;const m={id:y("m"),author:"Support",text:h.trim(),createdAt:new Date().toISOString()};return{...a,messages:[...a.messages||[],m],status:"open"}});x(t),d(""),o(s)},O=s=>{if(!confirm("Mark ticket resolved?"))return;const t=c.map(a=>a.id===s?{...a,status:"resolved"}:a);x(t),o(s)},_=s=>{if(!confirm("Delete ticket permanently?"))return;const t=c.filter(a=>a.id!==s);x(t),o(null)},U=()=>{const s=[["ticketId","subject","status","createdAt","messageId","author","messageText","messageCreatedAt"]];c.forEach(n=>{(n.messages||[]).forEach(u=>{s.push([n.id,n.subject,n.status,n.createdAt,u.id,u.author,u.text,u.createdAt])}),(!n.messages||n.messages.length===0)&&s.push([n.id,n.subject,n.status,n.createdAt,"","","",""])});const t=s.map(n=>n.map(u=>`"${String(u??"").replace(/"/g,'""')}"`).join(",")).join(`
`),a=new Blob([t],{type:"text/csv;charset=utf-8;"}),m=URL.createObjectURL(a),l=document.createElement("a");l.href=m,l.download=`kookit_tickets_${new Date().toISOString().slice(0,10)}.csv`,document.body.appendChild(l),l.click(),l.remove(),URL.revokeObjectURL(m)},Z=()=>{T("kookit_tickets",{tickets:j}),b(j),o(null)},r=c.find(s=>s.id===A);return e.jsxs("div",{className:"container-fluid",children:[e.jsxs("div",{className:"d-flex justify-content-between align-items-start mb-3 gap-2",children:[e.jsxs("div",{children:[e.jsx("h3",{children:"Support"}),e.jsx("div",{className:"text-muted small",children:"Manage support tickets, reply and resolve issues"})]}),e.jsxs("div",{className:"d-flex gap-2",children:[e.jsxs("div",{className:"input-group input-group-sm",style:{minWidth:220},children:[e.jsx("input",{className:"form-control form-control-sm",placeholder:"Search tickets...",value:g,onChange:s=>C(s.target.value)}),e.jsx("button",{className:"btn btn-outline-secondary",onClick:()=>C(""),children:"Clear"})]}),e.jsxs("select",{className:"form-select form-select-sm",value:f,onChange:s=>D(s.target.value),children:[e.jsx("option",{value:"open",children:"Open"}),e.jsx("option",{value:"resolved",children:"Resolved"}),e.jsx("option",{value:"all",children:"All"})]}),e.jsx("button",{className:"btn btn-outline-success btn-sm",onClick:U,children:"Export CSV"}),e.jsx("button",{className:"btn btn-outline-secondary btn-sm",onClick:Z,children:"Reset"})]})]}),e.jsxs("div",{className:"row g-3",children:[e.jsxs("div",{className:"col-md-4",children:[e.jsx("div",{className:"card shadow-sm mb-3",children:e.jsxs("div",{className:"card-body",children:[e.jsx("h6",{className:"mb-2",children:"New ticket"}),e.jsxs("form",{onSubmit:L,children:[e.jsx("div",{className:"mb-2",children:e.jsx("input",{className:"form-control form-control-sm",placeholder:"Subject",value:N,onChange:s=>k(s.target.value)})}),e.jsx("div",{className:"mb-2",children:e.jsxs("select",{className:"form-select form-select-sm",value:p,onChange:s=>w(s.target.value),children:[e.jsx("option",{value:"",children:"(no user)"}),v.map(s=>e.jsxs("option",{value:s.id,children:[s.name," — ",s.id]},s.id))]})}),e.jsx("div",{className:"mb-2",children:e.jsx("textarea",{className:"form-control form-control-sm",rows:3,placeholder:"Message (optional)",value:h,onChange:s=>d(s.target.value)})}),e.jsxs("div",{className:"d-flex gap-2",children:[e.jsx("button",{className:"btn btn-primary btn-sm",type:"submit",children:"Create"}),e.jsx("button",{className:"btn btn-outline-secondary btn-sm",type:"button",onClick:()=>{k(""),d(""),w("")},children:"Clear"})]})]})]})}),e.jsx("div",{className:"card shadow-sm",children:e.jsxs("div",{className:"card-body p-2",style:{maxHeight:"60vh",overflowY:"auto"},children:[I.length===0&&e.jsx("div",{className:"text-center text-muted p-3",children:"No tickets"}),e.jsx("ul",{className:"list-group",children:I.map(s=>e.jsxs("li",{className:`list-group-item list-group-item-action d-flex justify-content-between align-items-start ${A===s.id?"active text-white":""}`,style:{cursor:"pointer"},onClick:()=>E(s.id),children:[e.jsxs("div",{style:{flex:1},children:[e.jsx("div",{className:"fw-semibold",children:s.subject}),e.jsx("div",{className:"text-muted small",children:s.userId?v.find(t=>t.id===s.userId)?.name??s.userId:"Admin/Guest"}),e.jsx("div",{className:"text-muted small",children:S(s.createdAt)})]}),e.jsx("div",{className:"ms-2 text-nowrap",children:e.jsx("span",{className:`badge ${s.status==="open"?"bg-warning text-dark":"bg-success"}`,children:s.status})})]},s.id))})]})})]}),e.jsx("div",{className:"col-md-8",children:r?e.jsx("div",{className:"card shadow-sm",children:e.jsxs("div",{className:"card-body",children:[e.jsxs("div",{className:"d-flex justify-content-between align-items-start mb-2",children:[e.jsxs("div",{children:[e.jsx("h5",{className:"mb-1",children:r.subject}),e.jsxs("div",{className:"small text-muted",children:[r.userId?v.find(s=>s.id===r.userId)?.name??r.userId:"Admin/Guest"," • ",S(r.createdAt)]})]}),e.jsxs("div",{className:"btn-group",children:[e.jsx("button",{className:"btn btn-sm btn-outline-secondary",onClick:()=>_(r.id),children:"Delete"}),r.status==="open"?e.jsx("button",{className:"btn btn-sm btn-success",onClick:()=>O(r.id),children:"Mark resolved"}):e.jsx("button",{className:"btn btn-sm btn-warning",onClick:()=>{confirm("Re-open ticket?")&&x(c.map(s=>s.id===r.id?{...s,status:"open"}:s))},children:"Re-open"})]})]}),e.jsx("div",{style:{maxHeight:"48vh",overflowY:"auto",padding:8,border:"1px solid #eee",borderRadius:6,marginBottom:12},children:(r.messages||[]).map(s=>e.jsxs("div",{className:"mb-3",children:[e.jsxs("div",{className:"d-flex justify-content-between",children:[e.jsx("div",{className:"fw-semibold",children:s.author}),e.jsx("div",{className:"text-muted small",children:S(s.createdAt)})]}),e.jsx("div",{children:s.text}),e.jsx("hr",{})]},s.id))}),e.jsxs("div",{children:[e.jsx("textarea",{className:"form-control mb-2",rows:3,placeholder:"Write a reply...",value:h,onChange:s=>d(s.target.value)}),e.jsxs("div",{className:"d-flex justify-content-end gap-2",children:[e.jsx("button",{className:"btn btn-outline-secondary btn-sm",onClick:()=>d(""),children:"Clear"}),e.jsx("button",{className:"btn btn-primary btn-sm",onClick:()=>M(r.id),children:"Send reply"})]})]})]})}):e.jsx("div",{className:"card shadow-sm",children:e.jsx("div",{className:"card-body text-center text-muted",children:"Select a ticket to view details."})})})]})]})}export{$ as default};
